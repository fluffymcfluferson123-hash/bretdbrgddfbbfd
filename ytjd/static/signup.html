<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign up • PHSP</title>
  <link rel="icon" href="/favicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">
  <style>
    :root{
      --bg:#0c0c0e; --card:#101014; --muted:#a8a8b2; --text:#f5f6f7;
      --border:rgba(255,255,255,.08); --brand:#6ea8ff; --shadow:rgba(0,0,0,.5);
      --focus:#8cc4ff; --ok:#32d583; --warn:#ffb020;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; background:
      radial-gradient(1200px 800px at 0% 0%, #13131a 0%, transparent 60%),
      radial-gradient(1200px 800px at 100% 100%, #141421 0%, transparent 60%),
      var(--bg);
      color:var(--text); font:14px/1.4 system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif; }
    a{ color:#c9d7ff; text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .fixed-nav-bar{ height:58px; }

    .wrap{ min-height:calc(100% - 58px); display:grid; place-items:center; padding:40px 16px; }
    .card{
      width:min(520px,92vw); background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)) , var(--card);
      border:1px solid var(--border); border-radius:18px; padding:28px 24px 22px;
      box-shadow:0 30px 80px var(--shadow), inset 0 1px 0 rgba(255,255,255,.04);
      backdrop-filter: blur(6px);
    }
    .brand{ display:flex; align-items:center; gap:10px; margin-bottom:8px; }
    .logo{ width:36px; height:36px; border-radius:10px; background:#1e1f2a; display:grid; place-items:center; border:1px solid var(--border); }
    .logo i{ font-size:20px; color:#fff; opacity:.9; }
    .title{ font-weight:800; font-size:22px; letter-spacing:.2px; }
    .muted{ color:var(--muted); margin-top:2px; font-size:13px; }

    form{ margin-top:18px; display:grid; gap:14px; }
    .field{ display:grid; gap:8px; }
    label{ font-size:12px; letter-spacing:.2px; color:#dcdde3; }
    .input{
      display:flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:12px;
      background:#0e0f12; padding:12px 12px;
    }
    .input:focus-within{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(140,196,255,.12); }
    .input input{ width:100%; background:transparent; border:none; outline:none; color:var(--text); font-size:14px; }
    .icon-btn{ background:#1a1b21; border:1px solid var(--border); color:#dcdde3; width:34px; height:34px; border-radius:8px; display:grid; place-items:center; cursor:pointer; }
    .icon-btn:hover{ background:#1f2027; }
    .hint{ font-size:12px; color:var(--muted); }
    .error{ display:none; color:#ff8080; font-size:12px; margin-top:-4px; }
    .meter{ height:8px; border-radius:999px; background:#1c1d22; overflow:hidden; border:1px solid var(--border); }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg, #ff6b6b, #ffd166, #00d084); transition: width .15s; }

    .actions{ display:flex; align-items:center; justify-content:space-between; margin-top:6px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px; cursor:pointer;
      background:linear-gradient(180deg, #2b6bff, #2154d9); border:none; color:#fff; padding:12px 18px;
      border-radius:12px; font-weight:700; letter-spacing:.2px; box-shadow:0 8px 24px rgba(43,107,255,.28);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .foot{ margin-top:12px; font-size:12px; color:var(--muted); display:flex; justify-content:space-between; }

    /* Modal for recovery code */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; place-items:center; z-index:9998;
    }
    .modal{ width:min(560px,92vw); background:#0f0f10; border:1px solid var(--border); border-radius:16px;
      padding:18px 16px; box-shadow:0 30px 80px rgba(0,0,0,.6); }
    .modal h3{ margin:0 0 6px 0; }
    .modal .muted{ margin-bottom:10px; }
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#121216; border:1px dashed rgba(255,255,255,.14);
      border-radius:12px; padding:12px; word-break:break-all; text-align:center; font-size:15px;
    }
    .modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
    .btn-ghost{ background:#191a1f; border:1px solid var(--border); color:#eaeaea; border-radius:10px; padding:10px 14px; }
    .btn-ghost:hover{ background:#1f2027; }
  </style>
</head>
<body>
  <div class="fixed-nav-bar"></div>

  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div class="logo"><i class="ri-rocket-2-line"></i></div>
        <div>
          <div class="title">Create your account</div>
          <div class="muted">One device = one account (anti-spam)</div>
        </div>
      </div>

      <form id="signupForm" autocomplete="off">
        <div class="field">
          <label for="username">Username</label>
          <div class="input"><i class="ri-user-3-line"></i><input id="username" required placeholder="yourname" maxlength="32"></div>
        </div>
        <div class="field">
          <label for="password">Password</label>
          <div class="input">
            <i class="ri-lock-2-line"></i>
            <input id="password" type="password" required minlength="8" placeholder="At least 8 characters">
            <button class="icon-btn" type="button" id="togglePw"><i class="ri-eye-line"></i></button>
          </div>
          <div class="meter"><div class="bar" id="bar"></div></div>
          <div class="hint">Use 12+ characters with a mix of letters, numbers & symbols.</div>
          <div class="error" id="err"></div>
        </div>
        <div class="field">
          <label for="confirm">Confirm password</label>
          <div class="input"><i class="ri-check-double-line"></i><input id="confirm" type="password" required placeholder="Repeat password"></div>
        </div>
        <div class="actions">
          <a href="/li">Have an account? Log in</a>
          <button class="btn" id="submitBtn"><i class="ri-user-add-line"></i> Create account</button>
        </div>
      </form>

      <div class="foot"><span>Protected setup.</span><span id="deviceHint" class="hint"></span></div>
    </div>
  </div>

  <!-- Recovery modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <h3>Save your recovery code</h3>
      <div class="muted">If you forget your password, this code can reset it. Store it in a password manager.</div>
      <div class="code" id="recoveryCode">loading…</div>
      <div class="modal-actions">
        <button class="btn-ghost" id="copyBtn"><i class="ri-file-copy-line"></i> Copy</button>
        <button class="btn" id="doneBtn"><i class="ri-check-line"></i> I saved it</button>
      </div>
    </div>
  </div>

  <script type="module" src="/static/session-nav.js"></script>
  <script>
    const $ = (s, el=document)=>el.querySelector(s);

    // device id (required by your /api/signup); keep it stable per device
    function getDeviceId(){
      let id = localStorage.getItem('phsp_did');
      if (!id){
        // 24 hex chars
        id = Array.from(crypto.getRandomValues(new Uint8Array(12))).map(b => b.toString(16).padStart(2,'0')).join('');
        localStorage.setItem('phsp_did', id);
      }
      return id;
    }
    $('#deviceHint').textContent = 'Device ID ' + getDeviceId().slice(0,6) + '•••';

    // password eye
    $('#togglePw').addEventListener('click', ()=>{
      const i = $('#password');
      const vis = i.type === 'password' ? 'text' : 'password';
      i.type = vis;
      $('#togglePw i').className = vis === 'password' ? 'ri-eye-line' : 'ri-eye-off-line';
      i.focus();
    });

    // strength meter
    function strength(pw){
      let s=0;
      if (pw.length >= 8) s++;
      if (pw.length >= 12) s++;
      if (/[a-z]/.test(pw) && /[A-Z]/.test(pw)) s++;
      if (/\d/.test(pw)) s++;
      if (/[^A-Za-z0-9]/.test(pw)) s++;
      return Math.min(5,s);
    }
    $('#password').addEventListener('input', (e)=>{
      const s = strength(e.target.value);
      $('#bar').style.width = (s*20)+'%';
    });

    // already logged-in?
    (async()=>{
      try{
        const r = await fetch('/api/session'); const j = await r.json();
        if (j.authenticated) location.replace('/');
      }catch{}
    })();

    // signup
    $('#signupForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const u = $('#username').value.trim();
      const p = $('#password').value;
      const c = $('#confirm').value;
      const btn = $('#submitBtn');
      $('#err').style.display='none';

      if (p !== c){
        $('#err').textContent = 'Passwords do not match.';
        $('#err').style.display='block';
        return;
      }
      if (p.length < 8){
        $('#err').textContent = 'Password must be at least 8 characters.';
        $('#err').style.display='block';
        return;
      }

      btn.disabled = true;
      try{
        const r = await fetch('/api/signup', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ username: u, password: p, deviceId: getDeviceId() })
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j?.error || 'Signup failed');
        // show recovery code modal
        $('#recoveryCode').textContent = j.recovery_code;
        $('#modal').style.display = 'grid';
      }catch(err){
        $('#err').textContent = err.message || 'Signup failed';
        $('#err').style.display='block';
      }finally{
        btn.disabled = false;
      }
    });

    $('#copyBtn').addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText($('#recoveryCode').textContent);
        $('#copyBtn').textContent = 'Copied!';
        setTimeout(()=>$('#copyBtn').textContent='Copy',1200);
      }catch{}
    });
    $('#doneBtn').addEventListener('click', ()=>{
      location.replace('/');
    });
  </script>
</body>
</html>
